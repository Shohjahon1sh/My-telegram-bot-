import telebot
from telebot import types
import random

TOKEN = "8502640628:AAENpEP5Pw3RPIzuyNq6YhaW1YhkaPIPgzs"
bot = telebot.TeleBot(TOKEN)

# Harflar
hiragana = {"a":"ã‚","i":"ã„","u":"ã†","e":"ãˆ","o":"ãŠ",
            "ka":"ã‹","ki":"ã","ku":"ã","ke":"ã‘","ko":"ã“",
            "sa":"ã•","shi":"ã—","su":"ã™","se":"ã›","so":"ã"}

katakana = {"a":"ã‚¢","i":"ã‚¤","u":"ã‚¦","e":"ã‚¨","o":"ã‚ª",
            "ka":"ã‚«","ki":"ã‚­","ku":"ã‚¯","ke":"ã‚±","ko":"ã‚³",
            "sa":"ã‚µ","shi":"ã‚·","su":"ã‚¹","se":"ã‚»","so":"ã‚½"}

# Soâ€˜zlar (chegaraga sigâ€˜adigan qisqa versiya, keyin kengaytiriladi)
words_500 = [
{"jp":"ã¿ãš","uz":"suv","romaji":"mizu"},
{"jp":"ã›ã‚“ã›ã„","uz":"ustoz","romaji":"sensei"},
{"jp":"ã¾ãªã¶","uz":"oâ€˜rganmoq","romaji":"manabu"},
{"jp":"ã­ã“","uz":"mushuk","romaji":"neko"},
{"jp":"ã„ã¬","uz":"it","romaji":"inu"},
{"jp":"ã‚„ã¾","uz":"togâ€˜","romaji":"yama"},
{"jp":"ã‹ã‚","uz":"daryo","romaji":"kawa"},
{"jp":"ã»ã‚“","uz":"kitob","romaji":"hon"},
{"jp":"ãŒã£ã“ã†","uz":"maktab","romaji":"gakkou"},
{"jp":"ãã‚‹ã¾","uz":"mashina","romaji":"kuruma"},
{"jp":"ã¨ã‘ã„","uz":"soat","romaji":"tokei"},
{"jp":"ã²ã¨","uz":"odam","romaji":"hito"},
{"jp":"ã„ãˆ","uz":"uy","romaji":"ie"},
{"jp":"ã­ã“","uz":"mushuk","romaji":"neko"},
{"jp":"ã¯ãª","uz":"gul","romaji":"hana"},
{"jp":"ãã«","uz":"davlat","romaji":"kuni"},
{"jp":"ãã‚‰","uz":"osmon","romaji":"sora"},
{"jp":"ã¿ã›","uz":"doâ€˜kon","romaji":"mise"},
{"jp":"ã¾ã¡","uz":"shahar","romaji":"machi"},
{"jp":"ã‚„ã•ã„","uz":"sabzavot","romaji":"yasai"},
{"jp":"ãã ã‚‚ã®","uz":"meva","romaji":"kudamono"},
{"jp":"ãŸã¾ã”","uz":"tuxum","romaji":"tamago"},
{"jp":"ã•ã‹ãª","uz":"baliq","romaji":"sakana"},
{"jp":"ã¨ã‚Š","uz":"qush","romaji":"tori"},
{"jp":"ã„ã‘","uz":"hovuz","romaji":"ike"},
{"jp":"ã†ã¿","uz":"dengiz","romaji":"umi"},
{"jp":"ãŸã‘","uz":"bambuk","romaji":"take"},
{"jp":"ãã•","uz":"oâ€˜t","romaji":"kusa"},
{"jp":"ã","uz":"daraxt","romaji":"ki"},
{"jp":"ã¯ã—","uz":"koâ€˜prik","romaji":"hashi"},
{"jp":"ã„ã—","uz":"tosh","romaji":"ishi"},
{"jp":"ã¤ã","uz":"oy","romaji":"tsuki"},
{"jp":"ã²","uz":"quyosh","romaji":"hi"},
{"jp":"ã¤ã¡","uz":"tuproq","romaji":"tsuchi"},
{"jp":"ãã¨","uz":"tashqarida","romaji":"soto"},
{"jp":"ãªã‹","uz":"ichida","romaji":"naka"},
{"jp":"ã¿ã","uz":"oâ€˜ng","romaji":"migi"},
{"jp":"ã²ã ã‚Š","uz":"chap","romaji":"hidari"},
{"jp":"ã¾ãˆ","uz":"oldida","romaji":"mae"},
{"jp":"ã†ã—ã‚","uz":"orqada","romaji":"ushiro"},
{"jp":"ã‚ã—","uz":"oyoqlar","romaji":"ashi"},
{"jp":"ã¦","uz":"qoâ€˜l","romaji":"te"},
{"jp":"ã‹ãŠ","uz":"yuz","romaji":"kao"},
{"jp":"ã‚","uz":"koâ€˜z","romaji":"me"},
{"jp":"ã¿ã¿","uz":"quloq","romaji":"mimi"},
{"jp":"ãã¡","uz":"ogâ€˜iz","romaji":"kuchi"},
{"jp":"ã¯","uz":"tish","romaji":"ha"},
{"jp":"ã‚†ã³","uz":"barmoq","romaji":"yubi"},
{"jp":"ãã³","uz":"boâ€˜yin","romaji":"kubi"},
{"jp":"ã‹ãŸ","uz":"elka","romaji":"kata"},
{"jp":"ã‚€ã­","uz":"koâ€˜krak","romaji":"mune"},
{"jp":"ã›ãªã‹","uz":"orqa","romaji":"senaka"},
{"jp":"ã“ã—","uz":"bel","romaji":"koshi"},
{"jp":"ã‚ãŸã¾","uz":"bosh","romaji":"atama"},
{"jp":"ã‚","uz":"koâ€˜z","romaji":"me"},
{"jp":"ãã‚‚","uz":"bulut","romaji":"kumo"},
{"jp":"ãã‚‰","uz":"osmon","romaji":"sora"},
{"jp":"ã²ã‹ã‚Š","uz":"yorugâ€˜lik","romaji":"hikari"},
{"jp":"ã‹ãœ","uz":"shamol","romaji":"kaze"},
{"jp":"ã‚ã‚","uz":"yomgâ€˜ir","romaji":"ame"},
{"jp":"ã‚†ã","uz":"qor","romaji":"yuki"},
{"jp":"ã¯ã‚Œ","uz":"quyoshli","romaji":"hare"},
{"jp":"ãã‚‚ã‚Š","uz":"bulutli","romaji":"kumori"},
{"jp":"ãŸã„ã‚ˆã†","uz":"quyosh","romaji":"taiyou"},
{"jp":"ã¤ã‚†","uz":"mavsum yomgâ€˜iri","romaji":"tsuyu"},
{"jp":"ã»ã—","uz":"yulduz","romaji":"hoshi"},
{"jp":"ã¤ãªã¿","uz":"toâ€˜lqin","romaji":"tsunami"},
{"jp":"ã‹ã„","uz":"dengiz mahsuloti","romaji":"kai"},
{"jp":"ã•ã°","uz":"skumbriya","romaji":"saba"},
{"jp":"ã„ã‹","uz":"kalamush","romaji":"ika"},
{"jp":"ãŸã“","uz":"oktupus","romaji":"tako"},
{"jp":"ãˆã³","uz":"krevetka","romaji":"ebi"},
{"jp":"ã«ã","uz":"goâ€˜sht","romaji":"niku"},
{"jp":"ã•ã¨ã†","uz":"shakar","romaji":"satou"},
{"jp":"ã—ãŠ","uz":"tuz","romaji":"shio"},
{"jp":"ã¿ã","uz":"miso","romaji":"miso"},
{"jp":"ã•ã‘","uz":"losos","romaji":"sake"},
{"jp":"ã¡ã‚ƒ","uz":"choy","romaji":"cha"},
{"jp":"ã¿ã‚‹ã","uz":"sut","romaji":"miruku"},
{"jp":"ã”ã¯ã‚“","uz":"guruch","romaji":"gohan"},
{"jp":"ãƒ‘ãƒ³","uz":"non","romaji":"pan"},
{"jp":"ãŸã¾ã”","uz":"tuxum","romaji":"tamago"},
{"jp":"ã‚„ã•ã„","uz":"sabzavot","romaji":"yasai"},
{"jp":"ãã ã‚‚ã®","uz":"meva","romaji":"kudamono"},
{"jp":"ã•ã‹ãª","uz":"baliq","romaji":"sakana"},
{"jp":"ã«ã","uz":"goâ€˜sht","romaji":"niku"},
{"jp":"ã¨ã‚Š","uz":"tovuq","romaji":"tori"},
{"jp":"ã—ã‚‡ãã©ã†","uz":"oshxona","romaji":"shokudou"},
{"jp":"ã‚Œã„ãã†ã“","uz":"muzlatkich","romaji":"reizouko"},
{"jp":"ã§ã‚“ã","uz":"elektr","romaji":"denki"},
{"jp":"ã§ã‚“ã‚","uz":"telefon","romaji":"denwa"},
{"jp":"ãã‚‹ã¾","uz":"mashina","romaji":"kuruma"},
{"jp":"ã˜ã¦ã‚“ã—ã‚ƒ","uz":"velosiped","romaji":"jitensha"},
{"jp":"ã§ã‚“ã—ã‚ƒ","uz":"poezd","romaji":"densha"},
{"jp":"ã²ã“ã†ã","uz":"samolyot","romaji":"hikouki"},
{"jp":"ãµã­","uz":"kema","romaji":"fune"},
{"jp":"ã†ã¿","uz":"dengiz","romaji":"umi"},
{"jp":"ã‹ã‚","uz":"daryo","romaji":"kawa"},
{"jp":"ã‚„ã¾","uz":"togâ€˜","romaji":"yama"},
{"jp":"ã‚‚ã‚Š","uz":"oâ€˜rmon","romaji":"mori"},
{"jp":"ã¯ãª","uz":"gul","romaji":"hana"},
{"jp":"ã","uz":"daraxt","romaji":"ki"},
{"jp":"ãã•","uz":"oâ€˜t","romaji":"kusa"},
{"jp":"ã„ã‘","uz":"hovuz","romaji":"ike"},
{"jp":"ã«ã‚","uz":"bogâ€˜","romaji":"niwa"},
{"jp":"ãã¨","uz":"tashqarida","romaji":"soto"},
{"jp":"ãªã‹","uz":"ichida","romaji":"naka"},
{"jp":"ã¾ãˆ","uz":"oldida","romaji":"mae"},
{"jp":"ã†ã—ã‚","uz":"orqada","romaji":"ushiro"},
{"jp":"ã¿ã","uz":"oâ€˜ng","romaji":"migi"},
{"jp":"ã²ã ã‚Š","uz":"chap","romaji":"hidari"},
{"jp":"ã†ãˆ","uz":"yuqorida","romaji":"ue"},
{"jp":"ã—ãŸ","uz":"pastda","romaji":"shita"},
{"jp":"ã¡ã‹","uz":"yaqin","romaji":"chika"},
{"jp":"ã¨ãŠ","uz":"uzoqlik","romaji":"too"},
{"jp":"ã²ã‚‹","uz":"kun","romaji":"hiru"},
{"jp":"ã‚ˆã‚‹","uz":"kech","romaji":"yoru"},
{"jp":"ã‚ã•","uz":"ertalab","romaji":"asa"},
{"jp":"ã°ã‚“","uz":"kechqurun","romaji":"ban"},
{"jp":"ã›ã‚“ã—ã‚…ã†","uz":"oâ€˜tgan hafta","romaji":"senshuu"},
{"jp":"ã“ã‚“ã—ã‚…ã†","uz":"shu","romaji":"konshuu"},
{"jp":"ã‚‰ã„ã—ã‚…ã†","uz":"kelasi hafta","romaji":"raishuu"},
{"jp":"ãã‚‡ã†","uz":"bugun","romaji":"kyou"},
{"jp":"ã‚ã—ãŸ","uz":"ertaga","romaji":"ashita"},
{"jp":"ãã®ã†","uz":"kecha","romaji":"kinou"},
{"jp":"ã¿ãš","uz":"suv","romaji":"mizu"},
{"jp":"ã›ã‚“ã›ã„","uz":"ustoz","romaji":"sensei"},
{"jp":"ã¾ãªã¶","uz":"oâ€˜rganmoq","romaji":"manabu"},
{"jp":"ã­ã“","uz":"mushuk","romaji":"neko"},
{"jp":"ã„ã¬","uz":"it","romaji":"inu"},
{"jp":"ã‚„ã¾","uz":"togâ€˜","romaji":"yama"},
{"jp":"ã‹ã‚","uz":"daryo","romaji":"kawa"},
{"jp":"ã»ã‚“","uz":"kitob","romaji":"hon"},
{"jp":"ãŒã£ã“ã†","uz":"maktab","romaji":"gakkou"},
{"jp":"ãã‚‹ã¾","uz":"mashina","romaji":"kuruma"},
# Davom ettirish mumkin, jami 500 ta
]

# Foydalanuvchi holati
users = {}

def init_user(uid):
    users[uid] = {
        "mode":"hiragana",    # hiragana, katakana, aralash
        "streak":0,           # harf quizdagi ketma-ket toâ€˜gâ€˜ri javob
        "used_words_quiz": set(),
        "used_words_lugat": set(),
        "waiting_word_quiz": False  # True boâ€˜lsa 1 ta soâ€˜z quiz yuboriladi
    }

# Menu yaratish
def main_menu(uid):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("Hiragana","Katakana","Aralash")
    markup.add("Lugâ€˜atlar")
    return markup

# Harf quiz yuborish
def send_letter_quiz(chat_id):
    u = users[chat_id]
    pool = hiragana if u["mode"]=="hiragana" else katakana if u["mode"]=="katakana" else {**hiragana,**katakana}
    correct_romaji = random.choice(list(pool.keys()))
    correct_jp = pool[correct_romaji]

    opts = [correct_jp]
    while len(opts)<3:
        o = random.choice(list(pool.values()))
        if o not in opts:
            opts.append(o)
    random.shuffle(opts)

    question = f"'{correct_romaji}' harfi qaysi yaponcha belgiga toâ€˜gâ€˜ri keladi?"
    bot.send_poll(chat_id, question=question, options=opts, type="quiz",
                  correct_option_id=opts.index(correct_jp), is_anonymous=False)

# Soâ€˜z quiz yuborish
def send_word_quiz(chat_id):
    u = users[chat_id]
    remaining_words = [w for w in words_500 if w["jp"] not in u.get("used_words_quiz", set())]
    if not remaining_words:
        remaining_words = words_500
        u["used_words_quiz"] = set()

    correct_word = random.choice(remaining_words)
    u.setdefault("used_words_quiz", set()).add(correct_word["jp"])

    opts = [correct_word["jp"]]
    while len(opts)<3:
        o = random.choice([w["jp"] for w in words_500])
        if o not in opts:
            opts.append(o)
    random.shuffle(opts)

    question = f"'{correct_word['romaji']}' soâ€˜zi qaysi variantda toâ€˜gâ€˜ri yozilgan?"
    bot.send_poll(chat_id, question=question, options=opts, type="quiz",
                  correct_option_id=opts.index(correct_word["jp"]), is_anonymous=False)

# Quiz yuborish
def send_quiz(chat_id):
    u = users[chat_id]
    if u["waiting_word_quiz"]:
        u["waiting_word_quiz"] = False
        send_word_quiz(chat_id)
    else:
        send_letter_quiz(chat_id)

# Poll javobini qayta ishlash
@bot.poll_answer_handler()
def handle_poll(answer):
    uid = answer.user.id
    if uid not in users:
        init_user(uid)
    u = users[uid]

    # Harf quiz ketma-ket javobni hisoblash
    u["streak"] += 1

    # 5 ketma-ket to'g'ri â†’ 1 ta soâ€˜z quiz yuboriladi keyingi safar
    if u["streak"] >=5:
        u["streak"] = 0
        u["waiting_word_quiz"] = True
        bot.send_message(uid,"ğŸ‰ 5 ta ketma-ket toâ€˜gâ€˜ri! Endi 1 ta soâ€˜z quiz keladi!")

    send_quiz(uid)

# Start komandasi
@bot.message_handler(commands=["start"])
def cmd_start(message):
    init_user(message.chat.id)
    bot.send_message(message.chat.id,"Rejimni tanlang:", reply_markup=main_menu(message.chat.id))

# Tugmalarni boshqarish
@bot.message_handler(func=lambda m: True)
def text_handler(message):
    uid = message.chat.id
    if uid not in users:
        init_user(uid)

    if message.text in ["Hiragana","Katakana","Aralash"]:
        users[uid]["mode"]=message.text.lower()
        bot.send_message(uid,f"{message.text} rejimi tanlandi.", reply_markup=main_menu(uid))
        send_quiz(uid)

    elif message.text=="Lugâ€˜atlar":
        remaining_words = [w for w in words_500 if w["jp"] not in users[uid]["used_words_lugat"]]
        if not remaining_words:
            bot.send_message(uid,"ğŸ“ Barcha soâ€˜zlar Lugâ€˜atlar menyusida yuborildi.", reply_markup=main_menu(uid))
            return
        sample_words = random.sample(remaining_words, min(30,len(remaining_words)))
        users[uid]["used_words_lugat"].update([w["jp"] for w in sample_words])
        msg = "ğŸ“ Tasodifiy 30 ta yaponcha soâ€˜z:\n" + "\n".join([f"{w['romaji']} â†’ {w['jp']}" for w in sample_words])
        bot.send_message(uid,msg,reply_markup=main_menu(uid))

    else:
        bot.send_message(uid,"Rejim tanlang yoki 'Lugâ€˜atlar' tugmasini bosing.", reply_markup=main_menu(uid))

bot.infinity_polling()
